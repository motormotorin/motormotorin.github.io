!function(e){var t={};function i(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(s,a,function(t){return e[t]}.bind(null,a));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t,i){},function(e,t,i){"use strict";i.r(t);i(0);function s(){this._listeners=[]}s.prototype={attach:function(e){this._listeners.push(e)},notify:function(...e){this._listeners.forEach(t=>{t(...e)})}};var a=s;var r=class{constructor(){this.$layerBtn=document.querySelector("#layers-btn"),this.$layersPanel=document.querySelector("#layers-sidebar")}showPanel(){this.$layersPanel.classList.add("show")}hidePanel(){this.$layersPanel.classList.remove("show")}addLayer(e){e=this.buildLayerElement(e);this.renderElement(e)}setWrapper(){var e=document.createElement("div");return e.classList.add("wrapper"),document.querySelector(".app .main .container").insertAdjacentElement("beforeend",e),e}removeWrapper(){var e=document.querySelector(".wrapper");e&&e.parentNode.removeChild(e)}buildLayerElement(e){return`\n            <div id=${e.id} class="sidebar__checkbox ${"active"===e.state?"":"sidebar__checkbox--disabled"}">\n                <div class="sidebar__btn shadow">\n                    <img src="./media/icons/${e.icon}.svg" alt="">\n                </div>\n                <span>${e.title}</span>\n            </div>\n        `}renderElement(e){this.$layersPanel.querySelector(".sidebar__container").insertAdjacentHTML("afterbegin",e)}toggleLayerVisibility(e){this.$layersPanel.querySelector("#"+e).classList.toggle("sidebar__checkbox--disabled")}};var n=class{constructor(e){this.layers=localStorage.getItem("layers")||{},this.view=new r,this.selectLayerEvent=new a,this.enable()}enable(){this.view.$layerBtn.addEventListener("click",e=>{this.view.setWrapper().addEventListener("click",e=>{this.view.removeWrapper(),this.view.hidePanel()},{once:!0}),this.view.showPanel()}),this.view.$layersPanel.addEventListener("click",e=>{e.target.id&&this.selectLayer(e.target)})}addLayer(e){this.view.addLayer(e)}selectLayer(e){var t=e.classList.contains("sidebar__checkbox--disabled")?"active":"disable";this.view.toggleLayerVisibility(e.id),this.selectLayerEvent.notify({id:e.id,state:t})}};function o(e){if(e&&"string"==typeof e)return e+"_"+Math.random().toString(36).substr(2,9);throw new TypeError("invalid format of prefix")}var c=class{static buildDescription(e){var t=this.createDescriptionContainer(e);return t.innerHTML=this.fillDescriptionContainer(e),t}static createDescriptionContainer(e){var t=document.createElement("div");return t.id=e.id,t.classList.add("description"),t}static fillDescriptionContainer(e){let t={sun:"вс",mon:"пн",tue:"вт",wed:"ср",thu:"чт",fri:"пт",sat:"сб"},i=Object.keys(t)[(new Date).getDay()];return`\n            <div class="description__card shadow">\n                <div class="description__container">\n                    <div class="description__info">\n                        <div class="line">\n                            <div class="label">${e.type}</div>\n                            <div class="value">${e.title}</div>\n                        </div>\n                        <div class="line">\n                            <div class="label">Местоположение</div>\n                            <div class="value">Корпус ${e.building}, уровень ${e.level}</div>\n                        </div>\n                        <div id="worktime" class="line">\n                            <div class="label">Рабочее время</div>\n                            <ul>\n                                ${function(){let s="";return Object.keys(e.worktime).forEach(e=>{s+=`<li id="${e}" ${e===i?'class="active"':""}>${t[e]}</li>`}),s}()}\n                            </ul>\n                            <div class="value">Работает: ${e.worktime[i]}</div>\n                        </div>\n                    </div>\n                    \x3c!--<div class="description__view">\n                        <div class="description__img shadow">\n                            <img src="../media/places/Barbershop_A_6.jpg" alt="">\n                        </div>\n                    </div>--\x3e\n                </div>\n                ${e.link?`<button class="description__learn-more">\n                    <a href="${e.link}" class="description__learn-more--text">Узнать больше</span>\n                </button>`:""}\n            </div>\n        `}static renderDescription(e){document.querySelector(".app .main .container").insertAdjacentElement("beforeend",e)}static changeWorktime(e,t,i){var s=Array.from(e.querySelectorAll("li")),a=e.querySelector("#worktime .value");s.forEach(e=>{e.id===i?e.classList.add("active"):e.classList.remove("active")}),a.innerText="Работает: "+t.worktime[i]}static removeDescription(e){e.parentNode.removeChild(e)}};class l{constructor(e){this.description=e,this.$description=c.buildDescription(e),c.renderDescription(this.$description),this.enableDescription()}enableDescription(){return this.$description.querySelector(".description__card").addEventListener("click",e=>{e.stopPropagation()}),this.$description.querySelector("ul").addEventListener("click",e=>{e.target.id&&c.changeWorktime(this.$description,this.description,e.target.id)}),this.clickHandler=this.remove.bind(this),setTimeout(()=>document.addEventListener("click",this.clickHandler,{once:!0}),50),this}remove(e){c.removeDescription(this.$description),e.preventDefault()}}var d=class{constructor(){this.descriptions=[]}printDescription(e){this.descriptions=[],this.descriptions.push(new l(e))}},h=i.p+"./media/A_contour.svg";i.p,i.p,i.p;var p=class{constructor(){this._map,this.localStorageLayers=JSON.parse(localStorage.getItem("layers"))||{},this.descriptionsController=new d,this.layersController=new n,this.layersController.selectLayerEvent.attach(this.selectLayer.bind(this)),mapboxgl.accessToken="pk.eyJ1IjoiZmxpc2VubzFrIiwiYSI6ImNrZWppdGt3ZTJnN2EyeW1pcDYybGx6dmwifQ.CEg962_9JqAVcivAYg87Qw",this._map=new mapboxgl.Map({container:"mapid",zoomControl:!1,maxZoom:20,minZoom:14,zoom:16,center:[131.89426848759467,43.02450002995938],maxBounds:[[131.88065,43.01961],[131.90511,43.03954]],style:"mapbox://styles/fliseno1k/ckdvl3yid0ywl19mwm7b4xwa6",attributionControl:!1});const e=async e=>{const t=await fetch(`./json/${e}.json`),i=await t.json();this.addGeoJSONLayer(i)};this._map.on("load",()=>{e("layer_7gdt8bfan"),e("layer_z2zzty2yz"),e("layer_uu3tsrpq4"),e("layer_4drxl0x5g"),e("layer_a84waq888")})}async loadLayers(){const e=await fetch("php/getJsonNames.php"),t=await e.text();console.log(t)}addGeoJSONLayer(e){this._map.loadImage(`./media/png-icons/${e.markersIcon}.png`,(t,i)=>{if(t)throw t;this._map.addImage(""+e.markersIcon,i),this._map.addSource(""+e.title,{type:"geojson",data:{type:"FeatureCollection",features:Object.values(e.places)}});let s=this._map.addLayer({id:""+e.id,type:"symbol",source:""+e.title,layout:{"icon-image":""+e.markersIcon,"icon-size":.6}});this._map.on("click",""+e.id,e=>{e.features[0].properties.description&&this.descriptionsController.printDescription(JSON.parse(e.features[0].properties.description))});let a=this.localStorageLayers[s.id];a?("active"===a?this.showLayer(e.id):this.hideLayer(e.id),this.layersController.addLayer({id:e.id,title:e.title,icon:e.markersIcon,state:a})):(this.setToStorage({id:s.id,state:"active"}),this.showLayer(e.id),this.layersController.addLayer({id:e.id,title:e.title,icon:e.markersIcon,state:"active"}))})}showLayer(e){this._map.setLayoutProperty(e,"visibility","visible")}hideLayer(e){this._map.setLayoutProperty(e,"visibility","none")}selectLayer(e){"active"===e.state?this.showLayer(e.id):this.hideLayer(e.id),this.setToStorage(e)}setToStorage(e){this.localStorageLayers[e.id]=e.state,localStorage.removeItem("layers"),localStorage.setItem("layers",JSON.stringify(this.localStorageLayers))}},m=i.p+"./media/message.svg";var u=class{constructor(){this.$messageBtn=document.querySelector(".btns-group #message-btn")}buildMessageBlock(){this.$messageBlock=this.createMessageBlock(),this.$messageBlock.innerHTML=this.fillMessageBlock(),this.render()}createMessageBlock(){var e=document.createElement("div");return e.classList.add("message-block"),e}fillMessageBlock(){return`\n            <div class="message-block__container shadow">\n                <div class="writable-message">\n                    <textarea name="mess" \n                        id="mess" \n                        onlyread="false" \n                        placeholder="Введите сообщение" \n                        maxlength="110" \n                        cols="30" rows="1"></textarea>\n                    <div id="send-btn" class="user-btn user-btn--small shadow">\n                        <img src="${m}" alt="">\n                    </div>\n                </div>\n            </div>`}render(){document.querySelector(".app .main .container").insertAdjacentElement("beforeend",this.$messageBlock),this.$messageBlock.classList.add("show")}removeMessageBlock(){try{this.$messageBlock.classList.remove("show"),setTimeout(()=>{this.$messageBlock.parentNode.removeChild(this.$messageBlock)},300)}catch(e){console.error(e)}}getValuerFromInput(){return this.$messageBlock.querySelector("textarea").value}showMarker(){this.$centeredMarker=document.querySelector(".centered-marker"),this.$centeredMarker.classList.add("show")}hideMarker(){this.$centeredMarker.classList.remove("show"),this.$centeredMarker=void 0}};var v=class{constructor(e){this._map=e,this._cookieName="nextmsgsndg",this.view=new u,this.clickHandler=e=>this.close(),this.notifyEvent=new a,this.enable()}enable(){return this.view.$messageBtn.addEventListener("click",e=>{document.querySelector("body").click(),e.stopPropagation(),this.enableChat()}),this}enableChat(){this.view.buildMessageBlock(),this.view.showMarker(),this.view.$messageBlock.addEventListener("click",e=>{if("send-btn"===e.target.id){var t=this.view.getValuerFromInput();this.sendMessage(t)}e.stopPropagation()}),document.addEventListener("click",this.clickHandler,{once:!0})}close(){this.view.removeMessageBlock(),this.view.hideMarker(),document.removeEventListener("click",this.clickHandler)}async sendMessage(e){const t=this._getCookie(this._cookieName);if(e.trim().length>5&&void 0===t){var i={Date:new Date,latlng:this._map.getCenter(),mess:e};try{const t=await fetch("php/bot.php",{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(i)});t.status>=200&&t.status<300?(this._writeCookie(),this.notifyEvent.notify("user-notification",e)):this.notifyEvent.notify("system-notification","Возникла ошибка при отправке сообщения")}catch(e){console.error(e)}this.close()}else if(void 0!==t){var s=new Date(t)-(new Date).getTime();this.close(),this.notifyEvent.notify("system-notification","Отправка сообщений будет доступна через: "+this._msToTime(s))}}_msToTime(e){parseInt(e%1e3/100);var t=Math.floor(e/1e3%60);return Math.floor(e/6e4%60)+"мин "+(t=t<10?"0"+t:t)+"с."}_writeCookie(){var e=new Date;e.setTime(e.getTime()+3e5);var t="; expires="+e.toUTCString();document.cookie=this._cookieName+"="+e+t+"; path=/"}_getCookie(e){const t=("; "+document.cookie).split(`; ${e}=`);if(2===t.length)return t.pop().split(";").shift()}},y=i.p+"./media/default.svg";var g=class{constructor(e){this._map=e,this.$geolocationBtn=document.querySelector("#location-btn"),this.enable(),this.notifyEvent=new a}enable(){this.$geolocationBtn.addEventListener("click",e=>{e.stopPropagation(),this.getLocation()})}onSuccess(e){let t=[e.coords.longitude,e.coords.latitude],i=(new mapboxgl.Marker).setLngLat(t).addTo(this._map);this._map.flyTo({center:t,zoom:17}),this._map.once("click",e=>{i.remove()})}onError(){this.notifyEvent("system-notification","Невозможно определить ваше положение")}getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(this.onSuccess.bind(this),this.onError.bind(this),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):this.notifyEvent("system-notification","Эта функция не поддерживается в вашем браузере")}locate(e){this._map.setView(e,18),this.showLocationByMarker(e)}showLocationByMarker(e){var t=new L.Marker(e,{icon:new L.Icon({iconUrl:y,iconSize:[30,30],iconAnchor:[15,15]}),draggable:!1});t.addTo(this._map),document.addEventListener("click",()=>t.remove(),{once:!0})}throwLocationErrorNotification(e){this.notifyEvent.notify("system-notification",e)}};var f=class{constructor(){this.$notificationsBlock=document.querySelector(".notifications")}print(e){this._clear(),this.$notificationsBlock.insertAdjacentHTML("beforeend",`<div class="notification ${e.type}">${e.value}</div>`),this._enable()}_enable(){document.addEventListener("click",this._clear.bind(this),{once:!0})}_clear(){Array.from(this.$notificationsBlock.children).forEach(e=>{e.classList.add("hide"),setTimeout(()=>e&&e.parentNode===this.$notificationsBlock?this.$notificationsBlock.removeChild(e):void 0,300)})}};var b=class{constructor(e,t){if("user-notification"!==e&&"system-notification"!==e)throw new TypeError("Неверный тип оповещений: "+e);this.type=e,this.value=t}};var w=class{constructor(e){this.map=e,this._loopId,this.layerId,this.sourceId,this.notifyEvent=new a,this.map.on("load",e=>{this.map.loadImage("./media/png-icons/blue-pin-marker.png",(e,t)=>{if(e)throw e;this.map.addImage("blue-pin-marker",t)}),this.enableLoop()})}async loopAction(){var e=await this.getMessages();e=this.filterMessages(e),this.removeMessages(),this.addMessages(e)}enableLoop(){this.loopAction(),this._loopId=setInterval(()=>{this.loopAction()},3e4)}disableLoop(){clearInterval(this._loopId)}removeMessages(){void 0!==this.layerId&&void 0!==this.sourceId&&(this.map.removeLayer(this.layerId),this.map.removeSource(this.sourceId))}addMessages(e){this.sourceId=o("msg_src"),this.layerId=o("msg_layer"),this.map.addSource(this.sourceId,{type:"geojson",data:{type:"FeaturreCollection",features:e}}),this.map.addLayer({id:""+this.layerId,type:"symbol",source:""+this.sourceId,layout:{"icon-image":"blue-pin-marker","icon-size":1}}),this.map.on("click",""+this.layerId,e=>{this.showMessage(e.features[0].properties.mess)})}filterMessages(e){return(e||[]).filter(e=>{if(2===e.geometry.coordinates.length){let t=e.properties.message;this.messages[t.id];if((new Date-new Date(t.Date))/36e5<12)return e}})}async getMessages(){try{const e=await fetch("php/getmess.php"),t=await e.json();return t.map(e=>{e.latlng.lng,e.latlng.lat}),t}catch(e){console.error("[messages]: "+e)}}showMessage(e){var t=JSON.stringify(e,null,2).replace(/\\"/g,"'").replace(/\\n/g,"<br>").replace(/\"/g,"");this.notifyEvent.notify(t)}};function k(){this.map=new p,this.userChat=new v(this.map._map),this.geolocation=new g(this.map._map),this.messages=new w(this.map._map),this.notificationsPrinter=new f,this.setupHandlers().enable()}window.addEventListener("load",e=>{const t=document.querySelector(".preloader");setTimeout(()=>{t.classList.add("preloader--out")},1e3),setTimeout(()=>{t.parentElement.removeChild(t)},2500)}),k.prototype={setupHandlers(){return this.printNotificationHandler=this.printNotification.bind(this),this},enable(){return this.geolocation.notifyEvent.attach(this.printNotificationHandler),this.userChat.notifyEvent.attach(this.printNotificationHandler),this},printNotification(e,t){this.notificationsPrinter.print(new b(e,t))}},new k}]);